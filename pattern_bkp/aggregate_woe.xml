<?xml version="1.0" encoding="utf-8" standalone="yes"?>

<pattern>
	<name>Aggregate WOE</name>
	<description>
		Weight of evidence for 1:n relationship between the label and the attribute.

		Average(WoE) works empirically better than sum(WoE) and naive Bayes.
	</description>
	<example>
		Average logarithmic odds that a customer is a female based on ids of purchased products.
	</example>
	<author>Jan Motl</author>
	<date>2015-03-08</date>
	<code> SELECT a.@base
				, avg(woe.woe) @columnName
			FROM @propagatedTable a
			JOIN (
				 SELECT @nominalColumn
				 	  , {fn log(((sum(case when @targetName='@targetValue' then 1.0 else 0 end)+1)/avg(total.total_default))
				 / ((sum(case when @targetName &lt;&gt; '@targetValue' then 1.0 else 0 end)+1)/avg(total.total_nondefault))) } *100
				 as woe
				 FROM @propagatedTable
					  , (SELECT sum(case when @targetName='@targetValue' then 1.0 else 0 end)+2 as total_default
					          , sum(case when @targetName &lt;&gt; '@targetValue' then 1.0 else 0 end)+2 as total_nondefault
					  FROM @propagatedTable) total
				 GROUP BY @nominalColumn
				 ) woe
			on a.@nominalColumn = woe.@nominalColumn
			GROUP BY a.@base
	</code>
	<cardinality>n</cardinality>
</pattern>
