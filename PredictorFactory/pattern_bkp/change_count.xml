<?xml version="1.0" encoding="utf-8" standalone="yes"?>

<pattern>
	<name>Change count</name>
	<description>
		Count number of changes in an ordered list.
		
		Note: This pattern is different from the count of duplicates - you can have a list of binary values, but still
		have more than two changes.
	</description>
	<author>Jan Motl</author>
	<date>2015-05-10</date>
	<code compatibility="PostgreSQL">SELECT @baseId
			     , @baseDate
			     , @baseTarget
			     , max(@timeColumn) AS "@columnName"
			FROM (SELECT @baseId
			           , @baseDate
			           , @baseTarget
			           , @timeColumn
		               , RANK() OVER (PARTITION BY @baseId, @baseDate ORDER BY @numericalColumn @sortOrder) AS rk 
		          FROM @propagatedTable
		          WHERE @numericalColumn IS NOT NULL
		          ) t
			WHERE  rk = 1
			GROUP BY @baseId, @baseDate, @baseTarget
			
			
			SELECT @baseId
			     , @baseDate
			     , @baseTarget
				 , sum(is_change) AS "@columnName"
			FROM (
			   SELECT @baseId
			        , @baseDate
			        , @baseTarget
					, (CASE WHEN lag(@column) OVER (ORDER BY @timeColumn) != @column
							THEN 1
							ELSE 0
						END) is_change
			   FROM @propagatedTable
			) t
			GROUP BY @baseId, @baseDate, @baseTarget
	</code>
	<parameter key="@column" value="@nominalColumn,@numericalColumn"/>
	<cardinality>n</cardinality>
</pattern>
