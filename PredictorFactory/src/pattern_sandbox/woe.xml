<?xml version="1.0" encoding="utf-8" standalone="yes"?>

<pattern>
	<name>WOE</name>
	<description>Weight of evidence.
	
	The implementation is from: https://qizeresearch.wordpress.com/2014/05/21/utilize-woe-to-replace-dummy-variables/
	
	Division by zero is handled by substituting denominator's 0 with 1 -> the estimates are biased in the edge scenarios.  
	SHOULD USE LAPLACE CORRECTION!
	
	NOTE: WORKS ONLY ON BINARY TARGETS!
	
	NOTE: ALSO WORKS ON CARDINALITY 1!
	
	Could theoretically update woe estimates based on already estimated samples from testing set.  

	</description>
	<author>Jan Motl</author>
	<date>2015-03-08</date>
	<code> SELECT a.@baseId
	           	, a.@baseDate
	           	, a.@baseTarget
				, avg(woe.woe) "@columnName"
			FROM @propagatedTable a
			JOIN 
				(
				SELECT @nominalColumn
					, log(sum(case when propagated_target='A' then 1.0 else 0 end)/avg(total.total_default)
				/ coalesce(nullif(sum(case when propagated_target='B' then 1.0 else 0 end)/avg(total.total_nondefault), 0), 1))*100
				as woe
				FROM @propagatedTable
					, (SELECT sum(case when propagated_target='A' then 1.0 else 0 end) as total_default,
					sum(case when propagated_target='B' then 1.0 else 0 end) as total_nondefault 
					FROM @propagatedTable) total
				GROUP BY @nominalColumn
				) woe
			on a.@nominalColumn = woe.@nominalColumn
			GROUP BY a.@baseId, a.@baseDate, a.@baseTarget
	</code>
	<cardinality>n</cardinality>
</pattern>
