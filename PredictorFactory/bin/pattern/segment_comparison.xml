<?xml version="1.0" encoding="utf-8" standalone="yes"?>

<pattern>
	<name>Segment comparison</name>
	<description>
		Value of the numerical field divided by a statistic (MEAN, PERCENTILE) of the nominal field. 
		Useful to be used in composition with pattern parent field or parent from hierarchical lookup.
		
		select Key
		  , Ratio(Field, Y)
		from Table t
		  left join (select Segmentor, Y = Statistic(Field)
		      from Table
		      where Filter
		      group by Segmentor) s 
		    on t.Segmentor=s.Segmentor		
	</description>
	<author>Filip Trojan</author>
	<date>2014-12-31</date>
	<code>SELECT @baseId
			, @baseDate
			, @baseTarget
			, CASE 
				WHEN Y IS NULL THEN NULL 
				WHEN Y=0 THEN -9999 
				ELSE @numericalColumn/Y 
			  END "@columnName"
	      FROM @propagatedTable a LEFT JOIN (SELECT @nominalColumn, avg(@numericalColumn) Y
	      	FROM @propagatedTable GROUP BY @nominalColumn) b ON a.@nominalColumn = b.@nominalColumn
	</code>
	<cardinality>1</cardinality>
</pattern>